(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var n in a)e.o(a,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:a[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.plugins,n=window.wp.editPost,i=window.wp.data,r=window.wp.apiFetch;var s=e.n(r);const l="timberland-ai-page-builder",o={prompt:"",isGenerating:!1,isMatching:!1,isAnalyzing:!1,patternMatches:[],selectedPattern:null,clarificationQuestions:[],clarificationAnswers:{},generatedMarkup:"",validationResult:null,apiResponse:null,error:null,history:[],isLoadingHistory:!1},c={setPrompt:e=>({type:"SET_PROMPT",prompt:e}),setGenerating:e=>({type:"SET_GENERATING",isGenerating:e}),setMatching:e=>({type:"SET_MATCHING",isMatching:e}),setAnalyzing:e=>({type:"SET_ANALYZING",isAnalyzing:e}),setPatternMatches:e=>({type:"SET_PATTERN_MATCHES",matches:e}),selectPattern:e=>({type:"SELECT_PATTERN",patternId:e}),clearMatches:()=>({type:"CLEAR_MATCHES"}),setClarificationQuestions:e=>({type:"SET_CLARIFICATION_QUESTIONS",questions:e}),setClarificationAnswer:(e,t)=>({type:"SET_CLARIFICATION_ANSWER",questionId:e,value:t}),clearClarification:()=>({type:"CLEAR_CLARIFICATION"}),setResult:(e,t,a)=>({type:"SET_RESULT",markup:e,validation:t,apiResponse:a}),setError:e=>({type:"SET_ERROR",error:e}),clearResult:()=>({type:"CLEAR_RESULT"}),setHistory:e=>({type:"SET_HISTORY",history:e}),setLoadingHistory:e=>({type:"SET_LOADING_HISTORY",isLoading:e}),checkMatches:(e,t,a)=>async({dispatch:n})=>{n.setMatching(!0),n.setError(null),n.clearMatches(),n.clearClarification(),n.clearResult();try{const i=await s()({path:"/taipb/v1/match",method:"POST",data:{prompt:e}});if(i.has_matches&&i.matches.length>0){const r=i.matches;if(1===r.length||r[0].score>=8&&(r.length<2||r[0].score>=1.5*r[1].score))return n.setMatching(!1),void n.analyzePattern(e,t,a,r[0].id);n.setPatternMatches(r)}else n.generateWithPattern(e,t,a,null)}catch{n.generateWithPattern(e,t,a,null)}finally{n.setMatching(!1)}},analyzePattern:(e,t,a,n)=>async({dispatch:i})=>{if(n){i.setAnalyzing(!0),i.setError(null),i.selectPattern(n);try{const r=await s()({path:"/taipb/v1/analyze",method:"POST",data:{prompt:e,use_pattern:n}});if(r.has_questions){i.setClarificationQuestions(r.questions);for(const e of r.questions)e.default&&i.setClarificationAnswer(e.id,e.default)}else i.generateWithPattern(e,t,a,n)}catch{i.generateWithPattern(e,t,a,n)}finally{i.setAnalyzing(!1)}}else i.generateWithPattern(e,t,a,null)},generateWithPattern:(e,t,a,n,i)=>async({dispatch:r})=>{r.setGenerating(!0),r.setError(null),r.clearMatches();let l=e;if(i&&Object.keys(i).length>0){const e=[];for(const[t,a]of Object.entries(i))if("hero_content_location"===t)"data_fields"===a?e.push("Apply title/text changes to the block data fields (title, subtitle, text), NOT to InnerBlocks."):"innerblocks"===a?e.push("Apply title/text changes to the InnerBlocks (wp:heading, wp:paragraph), NOT to data fields."):"both"===a&&e.push("Apply title/text changes to BOTH the block data fields AND the InnerBlocks.");else if("image_handling"===t)if("keep"===a)e.push("Keep the existing pattern image unchanged.");else if("clear"===a)e.push("Remove the image so I can set it manually.");else if("provide_name"===a){const t=i.image_handling_value||"";t&&e.push(`Use the image named "${t}" from the media library for the image field.`)}else if("provide_url"===a){const t=i.image_handling_value||"";t&&e.push(`Use this image URL for the image field: ${t}`)}e.length>0&&(l+="\n\n[User clarifications: "+e.join(" ")+"]")}try{const e={prompt:l,post_type:t||"page",post_id:a||null};n&&(e.use_pattern=n);const i=await s()({path:"/taipb/v1/generate",method:"POST",data:e});i.error?r.setError(i.error):r.setResult(i.markup,i.validation,i.api_response)}catch(e){const t=e?.message||e?.error||e?.data?.message||("string"==typeof e?e:"Generation failed. Please try again.");r.setError(t)}finally{r.setGenerating(!1),r.clearClarification()}},fetchHistory:e=>async({dispatch:t})=>{t.setLoadingHistory(!0);try{const a=new URLSearchParams({per_page:"10"});e&&a.set("post_id",e);const n=await s()({path:`/taipb/v1/history?${a.toString()}`});t.setHistory(n.items||[])}catch{}finally{t.setLoadingHistory(!1)}}},p=(0,i.createReduxStore)(l,{reducer:(e=o,t)=>{switch(t.type){case"SET_PROMPT":return{...e,prompt:t.prompt};case"SET_GENERATING":return{...e,isGenerating:t.isGenerating};case"SET_MATCHING":return{...e,isMatching:t.isMatching};case"SET_ANALYZING":return{...e,isAnalyzing:t.isAnalyzing};case"SET_PATTERN_MATCHES":return{...e,patternMatches:t.matches};case"SELECT_PATTERN":return{...e,selectedPattern:t.patternId};case"CLEAR_MATCHES":return{...e,patternMatches:[],selectedPattern:null};case"SET_CLARIFICATION_QUESTIONS":return{...e,clarificationQuestions:t.questions};case"SET_CLARIFICATION_ANSWER":return{...e,clarificationAnswers:{...e.clarificationAnswers,[t.questionId]:t.value}};case"CLEAR_CLARIFICATION":return{...e,clarificationQuestions:[],clarificationAnswers:{}};case"SET_RESULT":return{...e,generatedMarkup:t.markup,validationResult:t.validation,apiResponse:t.apiResponse,error:null};case"SET_ERROR":return{...e,error:t.error};case"CLEAR_RESULT":return{...e,generatedMarkup:"",validationResult:null,apiResponse:null,error:null};case"SET_HISTORY":return{...e,history:t.history};case"SET_LOADING_HISTORY":return{...e,isLoadingHistory:t.isLoading};default:return e}},actions:c,selectors:{getPrompt:e=>e.prompt,isGenerating:e=>e.isGenerating,isMatching:e=>e.isMatching,isAnalyzing:e=>e.isAnalyzing,getPatternMatches:e=>e.patternMatches,getSelectedPattern:e=>e.selectedPattern,getClarificationQuestions:e=>e.clarificationQuestions,getClarificationAnswers:e=>e.clarificationAnswers,getGeneratedMarkup:e=>e.generatedMarkup,getValidationResult:e=>e.validationResult,getApiResponse:e=>e.apiResponse,getError:e=>e.error,getHistory:e=>e.history,isLoadingHistory:e=>e.isLoadingHistory}});(0,i.register)(p);const u=window.wp.components;function m({postType:e,postId:a}){const{prompt:n,isGenerating:r,isMatching:s,isAnalyzing:o}=(0,i.useSelect)(e=>({prompt:e(l).getPrompt(),isGenerating:e(l).isGenerating(),isMatching:e(l).isMatching(),isAnalyzing:e(l).isAnalyzing()}),[]),{setPrompt:c,checkMatches:p}=(0,i.useDispatch)(l),m=r||s||o,d=()=>{n.trim()&&!m&&p(n,e,a)},g=s?"Finding patterns...":o?"Analyzing...":r?"Generating...":"Generate Layout";return(0,t.createElement)("div",{className:"taipb-prompt-input"},(0,t.createElement)(u.TextareaControl,{label:"Describe the layout you want",help:"e.g., Create a hero section with a heading, subtitle, and CTA button, followed by a 3-column card grid.",value:n,onChange:c,onKeyDown:e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&d()},rows:4,disabled:m}),(0,t.createElement)(u.Button,{variant:"primary",onClick:d,isBusy:m,disabled:!n.trim()||m,className:"taipb-generate-button"},g))}function d({postType:e,postId:a}){const{prompt:n,matches:r,isGenerating:s,isAnalyzing:o}=(0,i.useSelect)(e=>({prompt:e(l).getPrompt(),matches:e(l).getPatternMatches(),isGenerating:e(l).isGenerating(),isAnalyzing:e(l).isAnalyzing()}),[]),{analyzePattern:c,generateWithPattern:p,clearMatches:m}=(0,i.useDispatch)(l);if(!r||0===r.length)return null;const d=s||o;return(0,t.createElement)("div",{className:"taipb-pattern-match"},(0,t.createElement)("p",{className:"taipb-pattern-match-heading"},"We found matching patterns/layouts. Use one as a base?"),(0,t.createElement)("div",{className:"taipb-pattern-match-list"},r.map(i=>(0,t.createElement)(u.Card,{key:i.id,size:"small",className:"taipb-pattern-match-item"},(0,t.createElement)(u.CardHeader,{size:"small"},(0,t.createElement)("span",{className:"taipb-pattern-match-title"},i.title),(0,t.createElement)("span",{className:"taipb-pattern-match-type"},i.type)),(0,t.createElement)(u.CardBody,{size:"small"},(0,t.createElement)(u.Button,{variant:"primary",size:"small",onClick:()=>{return t=i.id,void c(n,e,a,t);var t},disabled:d,isBusy:o,className:"taipb-pattern-use-button"},o?"Analyzing...":"Use this pattern"))))),(0,t.createElement)("div",{className:"taipb-pattern-match-actions"},(0,t.createElement)(u.Button,{variant:"secondary",onClick:()=>{p(n,e,a,null)},disabled:d,isBusy:s,className:"taipb-pattern-skip-button"},s?"Generating...":"Generate from scratch instead"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>{m()},disabled:d,className:"taipb-pattern-cancel-button"},"Cancel")))}function g({postType:e,postId:a}){const{prompt:n,questions:r,answers:s,selectedPattern:o,isGenerating:c}=(0,i.useSelect)(e=>({prompt:e(l).getPrompt(),questions:e(l).getClarificationQuestions(),answers:e(l).getClarificationAnswers(),selectedPattern:e(l).getSelectedPattern(),isGenerating:e(l).isGenerating()}),[]),{setClarificationAnswer:p,generateWithPattern:m,clearClarification:d}=(0,i.useDispatch)(l);if(!r||0===r.length)return null;const g=r.some(e=>{const t=s[e.id]||e.default||"";return("provide_name"===t||"provide_url"===t)&&!s[`${e.id}_value`]?.trim()});return(0,t.createElement)("div",{className:"taipb-clarification"},(0,t.createElement)("p",{className:"taipb-clarification-heading"},"A few questions before generating:"),r.map(e=>{const a=s[e.id]||e.default||"",n="provide_name"===a||"provide_url"===a;return(0,t.createElement)("div",{key:e.id,className:"taipb-clarification-question"},(0,t.createElement)(u.RadioControl,{label:e.question,selected:a,options:e.options.map(e=>({label:e.label,value:e.value})),onChange:t=>p(e.id,t)}),n&&(0,t.createElement)(u.TextControl,{label:"provide_name"===a?"Image filename":"Image URL",placeholder:"provide_name"===a?"e.g., my-hero-image.jpg":"https://example.com/image.jpg",value:s[`${e.id}_value`]||"",onChange:t=>p(`${e.id}_value`,t),className:"taipb-clarification-text-input"}))}),(0,t.createElement)("div",{className:"taipb-clarification-actions"},(0,t.createElement)(u.Button,{variant:"primary",onClick:()=>{m(n,e,a,o,s)},disabled:c||g,isBusy:c},c?"Generating...":"Generate"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>{d()},disabled:c},"Cancel")))}const h=window.wp.element,y=window.wp.blockEditor,E=window.wp.blocks;function b(){const{markup:e,validation:a,apiResponse:n,error:r}=(0,i.useSelect)(e=>({markup:e(l).getGeneratedMarkup(),validation:e(l).getValidationResult(),apiResponse:e(l).getApiResponse(),error:e(l).getError()}),[]),s=(0,h.useMemo)(()=>{if(!e)return[];try{return(0,E.parse)(e).filter(e=>"core/freeform"!==e.name||e.attributes.content?.trim())}catch{return[]}},[e]);return r?(0,t.createElement)(u.Notice,{status:"error",isDismissible:!1},r):e?(0,t.createElement)("div",{className:"taipb-preview-panel"},a&&(0,t.createElement)("div",{className:"taipb-validation"},(0,t.createElement)(u.Notice,{status:a.valid?"success":"warning",isDismissible:!1},a.valid?`Valid markup — ${a.block_count} blocks`:`${a.errors.length} validation error(s)`),a.errors.length>0&&(0,t.createElement)("ul",{className:"taipb-validation-errors"},a.errors.map((e,a)=>(0,t.createElement)("li",{key:a},e))),a.warnings.length>0&&(0,t.createElement)("ul",{className:"taipb-validation-warnings"},a.warnings.map((e,a)=>(0,t.createElement)("li",{key:a},e)))),s.length>0&&(0,t.createElement)("div",{className:"taipb-visual-preview"},(0,t.createElement)(y.BlockPreview,{blocks:s,viewportWidth:1200})),n&&(0,t.createElement)("div",{className:"taipb-token-usage"},(0,t.createElement)(u.__experimentalText,{size:"small",isBlock:!0},"Model: ",n.model),(0,t.createElement)(u.__experimentalText,{size:"small",isBlock:!0},"Tokens: ",n.input_tokens.toLocaleString()," in /"," ",n.output_tokens.toLocaleString()," out")),(0,t.createElement)("details",{className:"taipb-markup-preview"},(0,t.createElement)("summary",null,"View raw markup"),(0,t.createElement)("pre",{className:"taipb-markup-code"},e))):null}function f(){const[e,a]=(0,h.useState)(null),n=(0,i.useSelect)(e=>e(l).getGeneratedMarkup(),[]),{clearResult:r}=(0,i.useDispatch)(l);if(!n)return null;const s=e=>{const t=function(e,t="append"){try{const a=(0,E.parse)(e);if(!a||0===a.length)return{success:!1,blockCount:0,error:"No valid blocks found in markup."};const n=a.filter(e=>"core/freeform"!==e.name||e.attributes?.content?.trim());if(0===n.length)return{success:!1,blockCount:0,error:"No valid blocks found in markup."};const r=(0,i.dispatch)("core/block-editor"),{getBlocks:s,getSelectedBlockClientId:l}=(0,i.select)("core/block-editor");switch(t){case"replace":{const e=s().map(e=>e.clientId);e.length>0&&r.removeBlocks(e),r.insertBlocks(n);break}case"insert":{const e=l();if(e){const t=s().findIndex(t=>t.clientId===e);r.insertBlocks(n,t+1)}else r.insertBlocks(n);break}default:r.insertBlocks(n)}return{success:!0,blockCount:n.length}}catch(e){return{success:!1,blockCount:0,error:e.message||"Failed to parse and insert blocks."}}}(n,e);a(t),t.success&&setTimeout(()=>{r(),a(null)},2e3)};return(0,t.createElement)("div",{className:"taipb-insert-buttons"},(0,t.createElement)(u.ButtonGroup,null,(0,t.createElement)(u.Button,{variant:"primary",onClick:()=>s("append")},"Append to page"),(0,t.createElement)(u.Button,{variant:"secondary",onClick:()=>s("insert")},"Insert at cursor"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>s("replace"),isDestructive:!0},"Replace all")),e&&(0,t.createElement)(u.Notice,{status:e.success?"success":"error",isDismissible:!1,className:"taipb-insert-notice"},e.success?`Inserted ${e.blockCount} block(s)`:e.error))}function v({postId:e}){const{history:a,isLoading:n}=(0,i.useSelect)(e=>({history:e(l).getHistory(),isLoading:e(l).isLoadingHistory()}),[]),{fetchHistory:r,setPrompt:s}=(0,i.useDispatch)(l);return(0,h.useEffect)(()=>{r(e)},[e]),n?(0,t.createElement)("div",{className:"taipb-history-loading"},(0,t.createElement)(u.Spinner,null)):a&&0!==a.length?(0,t.createElement)("div",{className:"taipb-history-panel"},a.map(e=>(0,t.createElement)("div",{key:e.id,className:"taipb-history-item"},(0,t.createElement)("div",{className:"taipb-history-prompt"},e.prompt),(0,t.createElement)("div",{className:"taipb-history-meta"},e.model," · ",e.input_tokens+e.output_tokens," tokens · ",new Date(e.created_at).toLocaleDateString()),(0,t.createElement)(u.Button,{variant:"link",isSmall:!0,onClick:()=>s(e.prompt)},"Reuse prompt")))):(0,t.createElement)("p",{className:"taipb-history-empty"},"No generation history yet.")}function k(){const e=(0,i.useSelect)(e=>e("core/editor")?.getCurrentPostType?.()||"page",[]),a=(0,i.useSelect)(e=>e("core/editor")?.getCurrentPostId?.()||null,[]);return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(u.PanelBody,{title:"Generate Layout",initialOpen:!0},(0,t.createElement)(m,{postType:e,postId:a}),(0,t.createElement)(d,{postType:e,postId:a}),(0,t.createElement)(g,{postType:e,postId:a}),(0,t.createElement)(b,null),(0,t.createElement)(f,null)),(0,t.createElement)(u.PanelBody,{title:"History",initialOpen:!1},(0,t.createElement)(v,{postId:a})))}(0,a.registerPlugin)("timberland-ai-page-builder",{icon:"layout",render:()=>(0,t.createElement)(n.PluginSidebar,{name:"timberland-ai-page-builder",title:"AI Page Builder",icon:"layout"},(0,t.createElement)(k,null))})})();