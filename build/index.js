(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var n in a)e.o(a,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:a[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.plugins,n=window.wp.editPost,s=window.wp.data,r=window.wp.apiFetch;var i=e.n(r);const l="timberland-ai-page-builder",o={prompt:"",selectedModel:window.taipbSettings?.defaultModel||"",generationMode:"multi-step",isGenerating:!1,isMatching:!1,isAnalyzing:!1,isStructuring:!1,isAssembling:!1,patternMatches:[],selectedPatterns:[],clarificationQuestions:[],clarificationAnswers:{},decomposition:null,blockTree:null,structureApiResponse:null,generatedMarkup:"",validationResult:null,apiResponse:null,error:null,history:[],isLoadingHistory:!1},c={setPrompt:e=>({type:"SET_PROMPT",prompt:e}),setModel:e=>({type:"SET_MODEL",model:e}),setGenerating:e=>({type:"SET_GENERATING",isGenerating:e}),setMatching:e=>({type:"SET_MATCHING",isMatching:e}),setAnalyzing:e=>({type:"SET_ANALYZING",isAnalyzing:e}),setPatternMatches:e=>({type:"SET_PATTERN_MATCHES",matches:e}),selectPatterns:e=>({type:"SELECT_PATTERNS",patternIds:e}),togglePattern:e=>({type:"TOGGLE_PATTERN",patternId:e}),clearMatches:()=>({type:"CLEAR_MATCHES"}),setClarificationQuestions:e=>({type:"SET_CLARIFICATION_QUESTIONS",questions:e}),setClarificationAnswer:(e,t)=>({type:"SET_CLARIFICATION_ANSWER",questionId:e,value:t}),clearClarification:()=>({type:"CLEAR_CLARIFICATION"}),setDecomposition:e=>({type:"SET_DECOMPOSITION",decomposition:e}),clearDecomposition:()=>({type:"CLEAR_DECOMPOSITION"}),setGenerationMode:e=>({type:"SET_GENERATION_MODE",mode:e}),setBlockTree:e=>({type:"SET_BLOCK_TREE",blockTree:e}),clearBlockTree:()=>({type:"CLEAR_BLOCK_TREE"}),setStructuring:e=>({type:"SET_STRUCTURING",isStructuring:e}),setAssembling:e=>({type:"SET_ASSEMBLING",isAssembling:e}),setStructureApiResponse:e=>({type:"SET_STRUCTURE_API_RESPONSE",apiResponse:e}),setResult:(e,t,a)=>({type:"SET_RESULT",markup:e,validation:t,apiResponse:a}),setError:e=>({type:"SET_ERROR",error:e}),clearResult:()=>({type:"CLEAR_RESULT"}),setHistory:e=>({type:"SET_HISTORY",history:e}),setLoadingHistory:e=>({type:"SET_LOADING_HISTORY",isLoading:e}),checkMatches:(e,t,a)=>async({dispatch:n,select:s})=>{n.setMatching(!0),n.setError(null),n.clearMatches(),n.clearClarification(),n.clearResult(),n.clearDecomposition(),n.clearBlockTree();const r=s.getGenerationMode();if("multi-step"===r)try{const t=await i()({path:"/taipb/v1/decompose",method:"POST",data:{prompt:e}});if(t.has_sections&&t.decomposition?.sections?.length>0)return n.setDecomposition(t.decomposition),void n.setMatching(!1)}catch{}try{if("direct"===r)try{const t=await i()({path:"/taipb/v1/decompose",method:"POST",data:{prompt:e}});if(t.has_sections&&t.decomposition?.sections?.length>0)return n.setDecomposition(t.decomposition),void n.setMatching(!1)}catch{}const s=await i()({path:"/taipb/v1/match",method:"POST",data:{prompt:e}});if(s.has_matches&&s.matches.length>0){const r=s.matches,i=r.filter(e=>e.score>=8);if((1===r.length||r[0].score>=8&&(r.length<2||r[0].score>=1.5*r[1].score))&&i.length<=1)return n.setMatching(!1),void n.analyzePatterns(e,t,a,[r[0].id]);if(i.length>=2)return n.setMatching(!1),void n.analyzePatterns(e,t,a,i.map(e=>e.id));n.setPatternMatches(r)}else n.generateWithPatterns(e,t,a,[])}catch{n.generateWithPatterns(e,t,a,[])}finally{n.setMatching(!1)}},analyzePatterns:(e,t,a,n)=>async({dispatch:s})=>{if(n&&0!==n.length){s.setAnalyzing(!0),s.setError(null),s.selectPatterns(n);try{const r=await i()({path:"/taipb/v1/analyze",method:"POST",data:{prompt:e,use_patterns:n}});if(r.has_questions){s.setClarificationQuestions(r.questions);for(const e of r.questions)e.default&&s.setClarificationAnswer(e.id,e.default)}else s.generateWithPatterns(e,t,a,n)}catch{s.generateWithPatterns(e,t,a,n)}finally{s.setAnalyzing(!1)}}else s.generateWithPatterns(e,t,a,[])},generateWithPatterns:(e,t,a,n,s)=>async({dispatch:r,select:l})=>{r.setGenerating(!0),r.setError(null),r.clearMatches();let o=e;if(s&&Object.keys(s).length>0){const e=[];for(const[t,a]of Object.entries(s)){const n=t.includes("__")?t.split("__").pop():t;if("hero_content_location"===n)"data_fields"===a?e.push("Apply title/text changes to the block data fields (title, subtitle, text), NOT to InnerBlocks."):"innerblocks"===a?e.push("Apply title/text changes to the InnerBlocks (wp:heading, wp:paragraph), NOT to data fields."):"both"===a&&e.push("Apply title/text changes to BOTH the block data fields AND the InnerBlocks.");else if("image_handling"===n)if("keep"===a)e.push("Keep the existing pattern image unchanged.");else if("clear"===a)e.push("Remove the image so I can set it manually.");else if("provide_name"===a){const a=t.includes("__")?t.replace("image_handling","image_handling_value"):"image_handling_value",n=s[a]||"";n&&e.push(`Use the image named "${n}" from the media library for the image field.`)}else if("provide_url"===a){const a=t.includes("__")?t.replace("image_handling","image_handling_value"):"image_handling_value",n=s[a]||"";n&&e.push(`Use this image URL for the image field: ${n}`)}}e.length>0&&(o+="\n\n[User clarifications: "+e.join(" ")+"]")}const c=l.getDecomposition();c?.sections?.length>0&&(o+="\n\n[Structured layout plan:\n"+c.sections.map((e,t)=>{let a=`Section ${t+1}: ${e.intent}`;return e.pattern_hint&&(a+=` (use pattern: ${e.pattern_hint})`),e.content&&Object.entries(e.content).forEach(([e,t])=>{t&&(a+=`\n  ${e}: ${t}`)}),a}).join("\n\n")+"\n]");const p=l.getModel();try{const e={prompt:o,post_type:t||"page",post_id:a||null};n&&n.length>0&&(e.use_patterns=n),p&&(e.model=p);const s=await i()({path:"/taipb/v1/generate",method:"POST",data:e});s.error?r.setError(s.error):r.setResult(s.markup,s.validation,s.api_response)}catch(e){const t=e?.message||e?.error||e?.data?.message||("string"==typeof e?e:"Generation failed. Please try again.");r.setError(t)}finally{r.setGenerating(!1),r.clearClarification(),r.clearDecomposition()}},generateStructure:(e,t,a)=>async({dispatch:n,select:s})=>{n.setStructuring(!0),n.setError(null);const r=s.getDecomposition();if(!r?.sections?.length)return n.setError("No layout plan available. Please start over."),void n.setStructuring(!1);const l=r.suggested_pattern_ids||[],o=s.getModel();try{const s={prompt:e,decomposition:r,use_patterns:l};o&&(s.model=o);const c=await i()({path:"/taipb/v1/structure",method:"POST",data:s});c.block_tree?.blocks?.length>0?(n.setBlockTree(c.block_tree),c.api_response&&n.setStructureApiResponse(c.api_response)):(n.setError("Structure generation returned no blocks. Falling back to direct generation..."),n.generateWithPatterns(e,t,a,l))}catch(s){const r=s?.message||s?.data?.message||"Structure generation failed.";n.setError(`${r} Falling back to direct generation...`),n.generateWithPatterns(e,t,a,l)}finally{n.setStructuring(!1)}},assembleMarkup:(e,t)=>async({dispatch:a,select:n})=>{a.setAssembling(!0),a.setError(null);const s=n.getBlockTree(),r=n.getPrompt();if(!s?.blocks?.length)return a.setError("No block tree to assemble."),void a.setAssembling(!1);try{const l=await i()({path:"/taipb/v1/assemble",method:"POST",data:{block_tree:s,prompt:r,post_id:t||null,post_type:e||"page"}}),o=n.getStructureApiResponse(),c=o?{model:o.model,input_tokens:o.input_tokens,output_tokens:o.output_tokens}:{model:"assembled",input_tokens:0,output_tokens:0};a.setResult(l.markup,l.validation,c)}catch(e){const t=e?.message||e?.data?.message||"Assembly failed. Please try again.";a.setError(t)}finally{a.setAssembling(!1),a.clearDecomposition()}},fetchHistory:e=>async({dispatch:t})=>{t.setLoadingHistory(!0);try{const a=new URLSearchParams({per_page:"10"});e&&a.set("post_id",e);const n=await i()({path:`/taipb/v1/history?${a.toString()}`});t.setHistory(n.items||[])}catch{}finally{t.setLoadingHistory(!1)}}},p=(0,s.createReduxStore)(l,{reducer:(e=o,t)=>{switch(t.type){case"SET_PROMPT":return{...e,prompt:t.prompt};case"SET_MODEL":return{...e,selectedModel:t.model};case"SET_GENERATING":return{...e,isGenerating:t.isGenerating};case"SET_MATCHING":return{...e,isMatching:t.isMatching};case"SET_ANALYZING":return{...e,isAnalyzing:t.isAnalyzing};case"SET_PATTERN_MATCHES":return{...e,patternMatches:t.matches};case"SELECT_PATTERNS":return{...e,selectedPatterns:t.patternIds};case"TOGGLE_PATTERN":return{...e,selectedPatterns:e.selectedPatterns.includes(t.patternId)?e.selectedPatterns.filter(e=>e!==t.patternId):[...e.selectedPatterns,t.patternId]};case"CLEAR_MATCHES":return{...e,patternMatches:[],selectedPatterns:[]};case"SET_CLARIFICATION_QUESTIONS":return{...e,clarificationQuestions:t.questions};case"SET_CLARIFICATION_ANSWER":return{...e,clarificationAnswers:{...e.clarificationAnswers,[t.questionId]:t.value}};case"CLEAR_CLARIFICATION":return{...e,clarificationQuestions:[],clarificationAnswers:{}};case"SET_DECOMPOSITION":return{...e,decomposition:t.decomposition};case"CLEAR_DECOMPOSITION":return{...e,decomposition:null};case"SET_GENERATION_MODE":return{...e,generationMode:t.mode};case"SET_BLOCK_TREE":return{...e,blockTree:t.blockTree};case"CLEAR_BLOCK_TREE":return{...e,blockTree:null,structureApiResponse:null};case"SET_STRUCTURING":return{...e,isStructuring:t.isStructuring};case"SET_ASSEMBLING":return{...e,isAssembling:t.isAssembling};case"SET_STRUCTURE_API_RESPONSE":return{...e,structureApiResponse:t.apiResponse};case"SET_RESULT":return{...e,generatedMarkup:t.markup,validationResult:t.validation,apiResponse:t.apiResponse,error:null};case"SET_ERROR":return{...e,error:t.error};case"CLEAR_RESULT":return{...e,generatedMarkup:"",validationResult:null,apiResponse:null,error:null};case"SET_HISTORY":return{...e,history:t.history};case"SET_LOADING_HISTORY":return{...e,isLoadingHistory:t.isLoading};default:return e}},actions:c,selectors:{getPrompt:e=>e.prompt,getModel:e=>e.selectedModel,getGenerationMode:e=>e.generationMode,isGenerating:e=>e.isGenerating,isMatching:e=>e.isMatching,isAnalyzing:e=>e.isAnalyzing,isStructuring:e=>e.isStructuring,isAssembling:e=>e.isAssembling,getPatternMatches:e=>e.patternMatches,getSelectedPatterns:e=>e.selectedPatterns,getClarificationQuestions:e=>e.clarificationQuestions,getClarificationAnswers:e=>e.clarificationAnswers,getDecomposition:e=>e.decomposition,getBlockTree:e=>e.blockTree,getStructureApiResponse:e=>e.structureApiResponse,getGeneratedMarkup:e=>e.generatedMarkup,getValidationResult:e=>e.validationResult,getApiResponse:e=>e.apiResponse,getError:e=>e.error,getHistory:e=>e.history,isLoadingHistory:e=>e.isLoadingHistory}});(0,s.register)(p);const u=window.wp.components;function d(){const e=(0,s.useSelect)(e=>e(l).getModel(),[]),{setModel:a}=(0,s.useDispatch)(l),n=window.taipbSettings?.models||[];if(n.length<=1)return null;const r={};n.forEach(e=>{const t=e.provider||"other";r[t]||(r[t]=[]),r[t].push(e)});const i={anthropic:"Anthropic",openai:"OpenAI"},o=Object.keys(r).length>1,c=[];return Object.entries(r).forEach(([e,t])=>{o&&c.push({label:`--- ${i[e]||e} ---`,value:`__group_${e}`,disabled:!0}),t.forEach(e=>{c.push({label:e.label,value:e.value})})}),(0,t.createElement)(u.SelectControl,{label:"Model",value:e,options:c,onChange:a,className:"taipb-model-selector"})}function m(){const e=(0,s.useSelect)(e=>e(l).getGenerationMode(),[]),{setGenerationMode:a}=(0,s.useDispatch)(l);return(0,t.createElement)("div",{className:"taipb-mode-toggle"},(0,t.createElement)(u.ToggleControl,{label:"Multi-step generation",help:"multi-step"===e?"Plan, review structure, then assemble. More accurate.":"Generate markup in a single LLM call. Faster but less precise.",checked:"multi-step"===e,onChange:e=>a(e?"multi-step":"direct")}))}function g({postType:e,postId:a}){const{prompt:n,isGenerating:r,isMatching:i,isAnalyzing:o,isStructuring:c,isAssembling:p}=(0,s.useSelect)(e=>({prompt:e(l).getPrompt(),isGenerating:e(l).isGenerating(),isMatching:e(l).isMatching(),isAnalyzing:e(l).isAnalyzing(),isStructuring:e(l).isStructuring(),isAssembling:e(l).isAssembling()}),[]),{setPrompt:d,checkMatches:m}=(0,s.useDispatch)(l),g=r||i||o||c||p,h=()=>{n.trim()&&!g&&m(n,e,a)},b=i?"Finding patterns...":o?"Analyzing...":c?"Building structure...":p?"Assembling...":r?"Generating...":"Generate Layout";return(0,t.createElement)("div",{className:"taipb-prompt-input"},(0,t.createElement)(u.TextareaControl,{label:"Describe the layout you want",help:"e.g., Create a hero section with a heading, subtitle, and CTA button, followed by a 3-column card grid.",value:n,onChange:d,onKeyDown:e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&h()},rows:4,disabled:g}),(0,t.createElement)(u.Button,{variant:"primary",onClick:h,isBusy:g,disabled:!n.trim()||g,className:"taipb-generate-button"},b))}function h({postType:e,postId:a}){const{decomposition:n,prompt:r,isGenerating:i,isAnalyzing:o,isStructuring:c,generationMode:p,blockTree:d}=(0,s.useSelect)(e=>({decomposition:e(l).getDecomposition(),prompt:e(l).getPrompt(),isGenerating:e(l).isGenerating(),isAnalyzing:e(l).isAnalyzing(),isStructuring:e(l).isStructuring(),generationMode:e(l).getGenerationMode(),blockTree:e(l).getBlockTree()}),[]),{setDecomposition:m,analyzePatterns:g,generateWithPatterns:h,generateStructure:b}=(0,s.useDispatch)(l);if(!n||!n.sections?.length||d)return null;const E=i||o||c;return(0,t.createElement)("div",{className:"taipb-layout-plan"},(0,t.createElement)("p",{className:"taipb-layout-plan-heading"},"Proposed layout plan:"),n.sections.map((e,a)=>(0,t.createElement)(u.Card,{key:a,size:"small",className:"taipb-layout-plan-section"},(0,t.createElement)(u.CardBody,null,(0,t.createElement)("div",{className:"taipb-layout-plan-section-header"},(0,t.createElement)("strong",null,"Section ",a+1,": ",e.intent),e.pattern_hint&&(0,t.createElement)("span",{className:"taipb-layout-plan-pattern"},e.pattern_hint)),e.content&&Object.entries(e.content).map(([e,s])=>s&&(0,t.createElement)(u.TextControl,{key:e,label:e,value:s,onChange:t=>((e,t,a)=>{const s={...n,sections:n.sections.map((n,s)=>s===e?{...n,content:{...n.content,[t]:a}}:n)};m(s)})(a,e,t),disabled:E})),(0,t.createElement)(u.Button,{variant:"tertiary",size:"small",isDestructive:!0,onClick:()=>(e=>{const t=n.sections.filter((t,a)=>a!==e);m({...n,sections:t,suggested_pattern_ids:t.map(e=>e.pattern_id).filter(Boolean)})})(a),disabled:E},"Remove section")))),(0,t.createElement)("div",{className:"taipb-layout-plan-actions"},(0,t.createElement)(u.Button,{variant:"primary",onClick:()=>{if("multi-step"===p)b(r,e,a);else{const t=n.sections.map(e=>e.pattern_id).filter(Boolean);t.length>0?g(r,e,a,t):h(r,e,a,[])}},disabled:E,isBusy:E,className:"taipb-layout-plan-confirm"},E?c?"Building structure...":"Processing...":"multi-step"===p?"Build block structure":"Generate from this plan"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>{m(null)},disabled:E,className:"taipb-layout-plan-discard"},"Discard plan")))}function b({postType:e,postId:a}){const{blockTree:n,prompt:r,isAssembling:i,isStructuring:o}=(0,s.useSelect)(e=>({blockTree:e(l).getBlockTree(),prompt:e(l).getPrompt(),isAssembling:e(l).isAssembling(),isStructuring:e(l).isStructuring()}),[]),{setBlockTree:c,assembleMarkup:p,clearBlockTree:d,setError:m}=(0,s.useDispatch)(l);if(!n||!n.blocks?.length)return null;const g=i||o,h=(e,t,a)=>{const s=JSON.parse(JSON.stringify(n));let r=null,i=s.blocks;for(let t=0;t<e.length;t++){const a=e[t];if(0===t)r=i[a];else{const e=r.children||[],t=r.inner_blocks||[];r=a<e.length?e[a]:t[a-e.length]}}r&&("_content"===t?r.content=a:"_level"===t?r.level=parseInt(a,10)||2:"_text"===t?r.text=a:(r.data||(r.data={}),r.data[t]=a)),c(s)};return(0,t.createElement)("div",{className:"taipb-structure-review"},(0,t.createElement)("p",{className:"taipb-structure-review-heading"},"Block structure:"),(0,t.createElement)("div",{className:"taipb-structure-tree"},n.blocks.map((e,a)=>(0,t.createElement)(E,{key:a,node:e,path:[a],depth:0,onUpdate:h,disabled:g}))),(0,t.createElement)("div",{className:"taipb-structure-review-actions"},(0,t.createElement)(u.Button,{variant:"primary",onClick:()=>{p(e,a)},disabled:g,isBusy:g},i?"Assembling...":"Assemble & Preview"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>{d()},disabled:g},"Back to plan")))}function E({node:e,path:a,depth:n,onUpdate:s,disabled:r}){const i=e.block||"",l=i.replace("acf/","").replace("core/",""),o=i.startsWith("core/"),c=e.data||{},p=e.children||[],u=e.inner_blocks||[],d=["acf/section","acf/row","acf/column"].includes(i),m=o?function(e){const t=[],a=(e.block||"").replace("core/","");return"heading"===a?(t.push({name:"_content",label:"Heading text",value:e.content||"",type:"text"}),t.push({name:"_level",label:"Level (1-6)",value:String(e.level||2),type:"text"})):"paragraph"===a?t.push({name:"_content",label:"Paragraph text",value:e.content||"",type:"textarea"}):"button"===a&&t.push({name:"_text",label:"Button text",value:e.text||"",type:"text"}),t}(e):function(e){const t=new Set(["mode","alignText","alignContent","col_width","col_width_0_width","col_width_0_breakpoint"]),a=["padding_","margin_","bg_"],n=[];for(const[s,r]of Object.entries(e)){if(s.startsWith("_"))continue;if(t.has(s))continue;if(a.some(e=>s.startsWith(e)))continue;if(""===r||null==r)continue;if("object"==typeof r)continue;const e=s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),i=s.includes("body")||s.includes("wysiwyg")||s.includes("content");n.push({name:s,label:e,value:String(r),type:i?"wysiwyg":"text"})}return n}(c);return(0,t.createElement)("div",{className:`taipb-block-node taipb-block-node--depth-${Math.min(n,4)}`},(0,t.createElement)("div",{className:"taipb-block-node-header"},(0,t.createElement)("span",{className:"taipb-block-node-name"},l),d&&c.col_width_0_width&&(0,t.createElement)("span",{className:"taipb-block-node-meta"},"col: ",c.col_width_0_width,"/12")),!d&&m.length>0&&(0,t.createElement)("div",{className:"taipb-block-node-fields"},m.map(e=>(0,t.createElement)(y,{key:e.name,field:e,path:a,onUpdate:s,disabled:r}))),p.length>0&&(0,t.createElement)("div",{className:"taipb-block-node-children"},p.map((e,i)=>(0,t.createElement)(E,{key:i,node:e,path:[...a,i],depth:n+1,onUpdate:s,disabled:r}))),u.length>0&&(0,t.createElement)("div",{className:"taipb-block-node-innerblocks"},u.map((e,i)=>{const l=p.length+i;return(0,t.createElement)(E,{key:`ib-${i}`,node:e,path:[...a,l],depth:n+1,onUpdate:s,disabled:r})})))}function y({field:e,path:a,onUpdate:n,disabled:s}){var r;return"wysiwyg"===e.type||"textarea"===e.type||"string"==typeof e.value&&e.value.length>80?(0,t.createElement)(u.TextareaControl,{label:e.label,value:e.value,onChange:t=>n(a,e.name,t),rows:3,disabled:s,className:"taipb-block-field"}):(0,t.createElement)(u.TextControl,{label:e.label,value:"string"==typeof e.value?e.value:String(null!==(r=e.value)&&void 0!==r?r:""),onChange:t=>n(a,e.name,t),disabled:s,className:"taipb-block-field"})}function _({postType:e,postId:a}){const{prompt:n,matches:r,selectedPatterns:i,isGenerating:o,isAnalyzing:c}=(0,s.useSelect)(e=>({prompt:e(l).getPrompt(),matches:e(l).getPatternMatches(),selectedPatterns:e(l).getSelectedPatterns(),isGenerating:e(l).isGenerating(),isAnalyzing:e(l).isAnalyzing()}),[]),{togglePattern:p,analyzePatterns:d,generateWithPatterns:m,clearMatches:g}=(0,s.useDispatch)(l);if(!r||0===r.length)return null;const h=o||c;return(0,t.createElement)("div",{className:"taipb-pattern-match"},(0,t.createElement)("p",{className:"taipb-pattern-match-heading"},"Select patterns to use as a base:"),(0,t.createElement)("div",{className:"taipb-pattern-match-list"},r.map(e=>{const a=i.includes(e.id);return(0,t.createElement)(u.Card,{key:e.id,size:"small",className:"taipb-pattern-match-item"+(a?" taipb-pattern-match-item--selected":""),onClick:()=>!h&&p(e.id)},(0,t.createElement)(u.CardHeader,{size:"small"},(0,t.createElement)(u.CheckboxControl,{__nextHasNoMarginBottom:!0,checked:a,onChange:()=>p(e.id),disabled:h}),(0,t.createElement)("span",{className:"taipb-pattern-match-title"},e.title),(0,t.createElement)("span",{className:"taipb-pattern-match-type"},e.type)))})),(0,t.createElement)("div",{className:"taipb-pattern-match-actions"},(0,t.createElement)(u.Button,{variant:"primary",onClick:()=>{d(n,e,a,i)},disabled:h||0===i.length,isBusy:c,className:"taipb-pattern-confirm-button"},c?"Analyzing...":`Use ${i.length||""} selected pattern${1!==i.length?"s":""}`),(0,t.createElement)(u.Button,{variant:"secondary",onClick:()=>{m(n,e,a,[])},disabled:h,isBusy:o,className:"taipb-pattern-skip-button"},o?"Generating...":"Generate from scratch instead"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>{g()},disabled:h,className:"taipb-pattern-cancel-button"},"Cancel")))}function f({postType:e,postId:a}){const{prompt:n,questions:r,answers:i,selectedPatterns:o,isGenerating:c}=(0,s.useSelect)(e=>({prompt:e(l).getPrompt(),questions:e(l).getClarificationQuestions(),answers:e(l).getClarificationAnswers(),selectedPatterns:e(l).getSelectedPatterns(),isGenerating:e(l).isGenerating()}),[]),{setClarificationAnswer:p,generateWithPatterns:d,clearClarification:m}=(0,s.useDispatch)(l);if(!r||0===r.length)return null;const g=r.some(e=>{const t=i[e.id]||e.default||"";return("provide_name"===t||"provide_url"===t)&&!i[`${e.id}_value`]?.trim()});return(0,t.createElement)("div",{className:"taipb-clarification"},(0,t.createElement)("p",{className:"taipb-clarification-heading"},"A few questions before generating:"),r.map(e=>{const a=i[e.id]||e.default||"",n="provide_name"===a||"provide_url"===a;return(0,t.createElement)("div",{key:e.id,className:"taipb-clarification-question"},(0,t.createElement)(u.RadioControl,{label:e.question,selected:a,options:e.options.map(e=>({label:e.label,value:e.value})),onChange:t=>p(e.id,t)}),n&&(0,t.createElement)(u.TextControl,{label:"provide_name"===a?"Image filename":"Image URL",placeholder:"provide_name"===a?"e.g., my-hero-image.jpg":"https://example.com/image.jpg",value:i[`${e.id}_value`]||"",onChange:t=>p(`${e.id}_value`,t),className:"taipb-clarification-text-input"}))}),(0,t.createElement)("div",{className:"taipb-clarification-actions"},(0,t.createElement)(u.Button,{variant:"primary",onClick:()=>{d(n,e,a,o,i)},disabled:c||g,isBusy:c},c?"Generating...":"Generate"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>{m()},disabled:c},"Cancel")))}const k=window.wp.element,S=window.wp.blockEditor,v=window.wp.blocks;function T(e){let t=e;t=t.replace(/^```(?:html|xml|php|plaintext)?\s*\n?/gim,""),t=t.replace(/\n?```\s*$/gm,"");const a=t.indexOf("\x3c!-- wp:");a>0&&(t=t.substring(a));const n=t.lastIndexOf("--\x3e");return n>0&&(t=t.substring(0,n+3)),t.trim()}function A(){const{markup:e,validation:a,apiResponse:n,error:r}=(0,s.useSelect)(e=>({markup:e(l).getGeneratedMarkup(),validation:e(l).getValidationResult(),apiResponse:e(l).getApiResponse(),error:e(l).getError()}),[]),[i,o]=(0,k.useState)(!1),c=(0,k.useMemo)(()=>{if(!e||!i)return[];try{return(0,v.parse)(T(e)).filter(e=>"core/freeform"!==e.name||e.attributes.content?.trim())}catch{return[]}},[e,i]),p=c.slice(0,5),d=c.length>5;return r?(0,t.createElement)(u.Notice,{status:"error",isDismissible:!1},r):e?(0,t.createElement)("div",{className:"taipb-preview-panel"},a&&(0,t.createElement)("div",{className:"taipb-validation"},(0,t.createElement)(u.Notice,{status:a.valid?"success":"warning",isDismissible:!1},a.valid?`Valid markup — ${a.block_count} blocks`:`${a.errors.length} validation error(s)`),a.errors.length>0&&(0,t.createElement)("ul",{className:"taipb-validation-errors"},a.errors.map((e,a)=>(0,t.createElement)("li",{key:a},e))),a.warnings.length>0&&(0,t.createElement)("ul",{className:"taipb-validation-warnings"},a.warnings.map((e,a)=>(0,t.createElement)("li",{key:a},e)))),!i&&(0,t.createElement)(u.Button,{variant:"secondary",size:"small",onClick:()=>o(!0),className:"taipb-show-preview-button"},"Show visual preview"),i&&p.length>0&&(0,t.createElement)("div",{className:"taipb-visual-preview"},(0,t.createElement)(S.BlockPreview,{blocks:p,viewportWidth:1200}),d&&(0,t.createElement)("p",{style:{padding:"8px 12px",fontSize:"11px",color:"#757575",margin:0}},"Preview showing first ",5," of ",c.length," blocks.")),n&&(0,t.createElement)("div",{className:"taipb-token-usage"},(0,t.createElement)(u.__experimentalText,{size:"small",isBlock:!0},"Model: ",n.model),(0,t.createElement)(u.__experimentalText,{size:"small",isBlock:!0},"Tokens: ",n.input_tokens.toLocaleString()," in /"," ",n.output_tokens.toLocaleString()," out")),(0,t.createElement)("details",{className:"taipb-markup-preview"},(0,t.createElement)("summary",null,"View raw markup"),(0,t.createElement)("pre",{className:"taipb-markup-code"},e))):null}function N(){const[e,a]=(0,k.useState)(null),n=(0,s.useSelect)(e=>e(l).getGeneratedMarkup(),[]),{clearResult:r}=(0,s.useDispatch)(l);if(!n)return null;const i=e=>{const t=function(e,t="append"){try{const a=T(e),n=(0,v.parse)(a);if(!n||0===n.length)return{success:!1,blockCount:0,error:"No valid blocks found in markup."};const r=n.filter(e=>"core/freeform"!==e.name||e.attributes?.content?.trim());if(0===r.length)return{success:!1,blockCount:0,error:"No valid blocks found in markup."};const i=(0,s.dispatch)("core/block-editor"),{getBlocks:l,getSelectedBlockClientId:o}=(0,s.select)("core/block-editor");switch(t){case"replace":{const e=l().map(e=>e.clientId);e.length>0&&i.removeBlocks(e),i.insertBlocks(r);break}case"insert":{const e=o();if(e){const t=l().findIndex(t=>t.clientId===e);i.insertBlocks(r,t+1)}else i.insertBlocks(r);break}default:i.insertBlocks(r)}return{success:!0,blockCount:r.length}}catch(e){return{success:!1,blockCount:0,error:e.message||"Failed to parse and insert blocks."}}}(n,e);a(t),t.success&&setTimeout(()=>{r(),a(null)},2e3)};return(0,t.createElement)("div",{className:"taipb-insert-buttons"},(0,t.createElement)(u.ButtonGroup,null,(0,t.createElement)(u.Button,{variant:"primary",onClick:()=>i("append")},"Append to page"),(0,t.createElement)(u.Button,{variant:"secondary",onClick:()=>i("insert")},"Insert at cursor"),(0,t.createElement)(u.Button,{variant:"tertiary",onClick:()=>i("replace"),isDestructive:!0},"Replace all")),e&&(0,t.createElement)(u.Notice,{status:e.success?"success":"error",isDismissible:!1,className:"taipb-insert-notice"},e.success?`Inserted ${e.blockCount} block(s)`:e.error))}function C({postId:e}){const{history:a,isLoading:n}=(0,s.useSelect)(e=>({history:e(l).getHistory(),isLoading:e(l).isLoadingHistory()}),[]),{fetchHistory:r,setPrompt:i}=(0,s.useDispatch)(l);return(0,k.useEffect)(()=>{r(e)},[e]),n?(0,t.createElement)("div",{className:"taipb-history-loading"},(0,t.createElement)(u.Spinner,null)):a&&0!==a.length?(0,t.createElement)("div",{className:"taipb-history-panel"},a.map(e=>(0,t.createElement)("div",{key:e.id,className:"taipb-history-item"},(0,t.createElement)("div",{className:"taipb-history-prompt"},e.prompt),(0,t.createElement)("div",{className:"taipb-history-meta"},e.model," · ",e.input_tokens+e.output_tokens," tokens · ",new Date(e.created_at).toLocaleDateString()),(0,t.createElement)(u.Button,{variant:"link",isSmall:!0,onClick:()=>i(e.prompt)},"Reuse prompt")))):(0,t.createElement)("p",{className:"taipb-history-empty"},"No generation history yet.")}function w(){const e=(0,s.useSelect)(e=>e("core/editor")?.getCurrentPostType?.()||"page",[]),a=(0,s.useSelect)(e=>e("core/editor")?.getCurrentPostId?.()||null,[]);return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(u.PanelBody,{title:"Generate Layout",initialOpen:!0},(0,t.createElement)(d,null),(0,t.createElement)(m,null),(0,t.createElement)(g,{postType:e,postId:a}),(0,t.createElement)(h,{postType:e,postId:a}),(0,t.createElement)(b,{postType:e,postId:a}),(0,t.createElement)(_,{postType:e,postId:a}),(0,t.createElement)(f,{postType:e,postId:a}),(0,t.createElement)(A,null),(0,t.createElement)(N,null)),(0,t.createElement)(u.PanelBody,{title:"History",initialOpen:!1},(0,t.createElement)(C,{postId:a})))}const P=window.wp.editor;function R({postId:e}){const[a,n]=(0,k.useState)(""),[s,r]=(0,k.useState)(!0),[l,o]=(0,k.useState)(!1),[c,p]=(0,k.useState)(!1),[d,m]=(0,k.useState)("");return(0,k.useEffect)(()=>{e&&i()({path:`/wp/v2/blocks/${e}`}).then(e=>n(e.meta?.taipb_usage_notes||"")).catch(()=>{})},[e]),(0,t.createElement)(t.Fragment,null,d&&(0,t.createElement)(u.Notice,{status:"error",isDismissible:!0,onRemove:()=>m("")},d),(0,t.createElement)(u.TextareaControl,{label:"Usage Notes",help:"Describe how this pattern should be used by the AI layout generator.",value:a,onChange:e=>{n(e),r(!1)},rows:3}),(0,t.createElement)(u.Flex,{justify:"flex-start",gap:2},(0,t.createElement)(u.Button,{variant:"secondary",size:"small",onClick:()=>{o(!0),m(""),i()({path:`/wp/v2/blocks/${e}`,method:"POST",data:{meta:{taipb_usage_notes:a}}}).then(()=>{o(!1),r(!0)}).catch(e=>{o(!1),m(e.message||"Failed to save.")})},disabled:l||s},l?"Saving...":s?"Saved":"Save Notes"),(0,t.createElement)(u.Button,{variant:"tertiary",size:"small",onClick:()=>{p(!0),m(""),i()({path:"/taipb/v1/generate-pattern-notes",method:"POST",data:{post_id:e}}).then(e=>{p(!1),e.notes&&(n(e.notes),r(!1))}).catch(e=>{p(!1),m(e.message||"Failed to generate.")})},disabled:c},c?"Generating...":"Auto-Generate")))}class I extends k.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}render(){return this.state.hasError?null:this.props.children}}function M(){const e=(0,s.useSelect)(e=>{try{return e("core/editor")?.getCurrentPostType?.()||null}catch{return null}},[]),a=(0,s.useSelect)(e=>{try{return e("core/editor")?.getCurrentPostId?.()||null}catch{return null}},[]);return"wp_block"===e&&a?(0,t.createElement)(P.PluginDocumentSettingPanel,{name:"taipb-usage-notes",title:"AI Usage Notes"},(0,t.createElement)(R,{postId:a})):null}(0,a.registerPlugin)("timberland-ai-page-builder",{icon:"layout",render:()=>(0,t.createElement)(n.PluginSidebar,{name:"timberland-ai-page-builder",title:"AI Page Builder",icon:"layout"},(0,t.createElement)(w,null))}),(0,a.registerPlugin)("taipb-pattern-usage-notes",{render:function(){return(0,t.createElement)(I,null,(0,t.createElement)(M,null))}})})();